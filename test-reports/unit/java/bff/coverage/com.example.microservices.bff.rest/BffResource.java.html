<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>BffResource.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Backend For Frontend (BFF)</a> &gt; <a href="index.source.html" class="el_package">com.example.microservices.bff.rest</a> &gt; <span class="el_source">BffResource.java</span></div><h1>BffResource.java</h1><pre class="source lang-java linenums">package com.example.microservices.bff.rest;

import com.example.microservices.bff.client.AuthServiceClient;
import com.example.microservices.bff.client.PointServiceClient;
import com.example.microservices.bff.client.UserServiceClient;

import javax.inject.Inject;
import javax.json.JsonObject;
import javax.ws.rs.*;
import javax.ws.rs.core.MediaType;
import javax.ws.rs.core.Response;
import java.util.HashMap;
import java.util.Map;
import java.util.UUID;

/**
 * BFF REST API
 * フロントエンドからのリクエストを各マイクロサービスにプロキシ
 */
@Path(&quot;/api&quot;)
@Produces(MediaType.APPLICATION_JSON)
@Consumes(MediaType.APPLICATION_JSON)
<span class="nc" id="L23">public class BffResource {</span>

    @Inject
    private UserServiceClient userServiceClient;

    @Inject
    private AuthServiceClient authServiceClient;

    @Inject
    private PointServiceClient pointServiceClient;

    // ==================== 認証エンドポイント ====================

    /**
     * ログイン
     */
    @POST
    @Path(&quot;/login&quot;)
    public Response login(Map&lt;String, Object&gt; loginData) {
        try {
            // リクエストボディの検証とログ出力
<span class="nc" id="L44">            System.out.println(&quot;Login request received: &quot; + loginData);</span>
            
<span class="nc bnc" id="L46" title="All 4 branches missed.">            if (loginData == null || !loginData.containsKey(&quot;password&quot;)) {</span>
<span class="nc" id="L47">                return createErrorResponse(&quot;Username and password are required&quot;);</span>
            }

            // userId または username を取得
<span class="nc" id="L51">            Object userIdObj = loginData.get(&quot;userId&quot;);</span>
<span class="nc" id="L52">            Object usernameObj = loginData.get(&quot;username&quot;);</span>
<span class="nc" id="L53">            String password = (String) loginData.get(&quot;password&quot;);</span>

            // loginData をそのまま転送
<span class="nc" id="L56">            Response authResponse = authServiceClient.login(loginData);</span>
<span class="nc" id="L57">            String body = authResponse.readEntity(String.class);</span>
<span class="nc" id="L58">            return Response.status(authResponse.getStatus())</span>
<span class="nc" id="L59">                    .entity(body)</span>
<span class="nc" id="L60">                    .build();</span>
<span class="nc" id="L61">        } catch (Exception e) {</span>
<span class="nc" id="L62">            e.printStackTrace();</span>
<span class="nc" id="L63">            return createErrorResponse(&quot;Login failed: &quot; + e.getMessage());</span>
        }
    }

    /**
     * ログアウト
     */
    @POST
    @Path(&quot;/logout&quot;)
    public Response logout(@HeaderParam(&quot;Authorization&quot;) String authHeader) {
        try {
<span class="nc bnc" id="L74" title="All 4 branches missed.">            if (authHeader == null || !authHeader.startsWith(&quot;Bearer &quot;)) {</span>
<span class="nc" id="L75">                return createErrorResponse(&quot;Invalid authorization header&quot;);</span>
            }

<span class="nc" id="L78">            String token = authHeader.substring(7);</span>
<span class="nc" id="L79">            Response authResponse = authServiceClient.logout(token);</span>
<span class="nc" id="L80">            String body = authResponse.readEntity(String.class);</span>
<span class="nc" id="L81">            return Response.status(authResponse.getStatus())</span>
<span class="nc" id="L82">                    .entity(body)</span>
<span class="nc" id="L83">                    .build();</span>
<span class="nc" id="L84">        } catch (Exception e) {</span>
<span class="nc" id="L85">            return createErrorResponse(&quot;Logout failed: &quot; + e.getMessage());</span>
        }
    }

    /**
     * トークン検証
     */
    @GET
    @Path(&quot;/verify&quot;)
    public Response verifyToken(@HeaderParam(&quot;Authorization&quot;) String authHeader) {
        try {
<span class="nc bnc" id="L96" title="All 4 branches missed.">            if (authHeader == null || !authHeader.startsWith(&quot;Bearer &quot;)) {</span>
<span class="nc" id="L97">                return createErrorResponse(&quot;Invalid authorization header&quot;);</span>
            }

<span class="nc" id="L100">            String token = authHeader.substring(7);</span>
<span class="nc" id="L101">            Response authResponse = authServiceClient.verifyToken(token);</span>
<span class="nc" id="L102">            String body = authResponse.readEntity(String.class);</span>
<span class="nc" id="L103">            return Response.status(authResponse.getStatus())</span>
<span class="nc" id="L104">                    .entity(body)</span>
<span class="nc" id="L105">                    .build();</span>
<span class="nc" id="L106">        } catch (Exception e) {</span>
<span class="nc" id="L107">            return createErrorResponse(&quot;Verification failed: &quot; + e.getMessage());</span>
        }
    }

    // ==================== ユーザー情報エンドポイント ====================

    /**
     * 会員画面用：ユーザーアカウント情報取得（認証付き）
     */
    @GET
    @Path(&quot;/account&quot;)
    public Response getAccount(@HeaderParam(&quot;Authorization&quot;) String authHeader) {
        try {
            // トークン検証
<span class="nc bnc" id="L121" title="All 4 branches missed.">            if (authHeader == null || !authHeader.startsWith(&quot;Bearer &quot;)) {</span>
<span class="nc" id="L122">                return Response.status(Response.Status.UNAUTHORIZED)</span>
<span class="nc" id="L123">                        .entity(createErrorMap(&quot;Invalid authorization header&quot;))</span>
<span class="nc" id="L124">                        .build();</span>
            }

<span class="nc" id="L127">            String token = authHeader.substring(7);</span>
<span class="nc" id="L128">            Response verifyResponse = authServiceClient.verifyToken(token);</span>
            
<span class="nc bnc" id="L130" title="All 2 branches missed.">            if (verifyResponse.getStatus() != 200) {</span>
<span class="nc" id="L131">                return Response.status(Response.Status.UNAUTHORIZED)</span>
<span class="nc" id="L132">                        .entity(createErrorMap(&quot;Invalid or expired token&quot;))</span>
<span class="nc" id="L133">                        .build();</span>
            }

            // トークンから userId を取得
<span class="nc" id="L137">            String verifyBody = verifyResponse.readEntity(String.class);</span>
            // 簡易的な実装（実際はJSON パースが必要）
<span class="nc" id="L139">            UUID userId = extractUserIdFromVerifyResponse(verifyBody);</span>

            // ユーザーアカウント情報取得
<span class="nc" id="L142">            Response userResponse = userServiceClient.getUserAccount(userId);</span>
<span class="nc bnc" id="L143" title="All 2 branches missed.">            if (userResponse.getStatus() != 200) {</span>
<span class="nc" id="L144">                return Response.status(userResponse.getStatus())</span>
<span class="nc" id="L145">                        .entity(userResponse.readEntity(String.class))</span>
<span class="nc" id="L146">                        .build();</span>
            }
<span class="nc" id="L148">            String userBody = userResponse.readEntity(String.class);</span>
            
            // ポイント情報取得
<span class="nc" id="L151">            Response pointResponse = null;</span>
<span class="nc" id="L152">            String pointsJson = null;</span>
            try {
<span class="nc" id="L154">                pointResponse = pointServiceClient.getPoints(token);</span>
<span class="nc bnc" id="L155" title="All 2 branches missed.">                if (pointResponse.getStatus() == 200) {</span>
<span class="nc" id="L156">                    pointsJson = pointResponse.readEntity(String.class);</span>
                }
<span class="nc" id="L158">            } catch (Exception e) {</span>
                // ポイントサービスにアクセスできない場合は無視（ポイント情報なしで返す）
<span class="nc" id="L160">                System.err.println(&quot;Failed to fetch points: &quot; + e.getMessage());</span>
<span class="nc" id="L161">            }</span>
            
            // ユーザー情報とポイント情報をマージ
<span class="nc" id="L164">            String mergedJson = mergeAccountAndPoints(userBody, pointsJson);</span>
            
<span class="nc" id="L166">            return Response.ok(mergedJson).build();</span>
<span class="nc" id="L167">        } catch (Exception e) {</span>
<span class="nc" id="L168">            return createErrorResponse(&quot;Failed to get account: &quot; + e.getMessage());</span>
        }
    }
    
    /**
     * ユーザー情報とポイント情報をマージ
     */
    private String mergeAccountAndPoints(String userJson, String pointsJson) {
        // 簡易的な実装（実際はJSONライブラリで適切にマージすべき）
<span class="nc bnc" id="L177" title="All 4 branches missed.">        if (pointsJson == null || pointsJson.trim().isEmpty()) {</span>
            // ポイント情報がない場合はユーザー情報のみ返す
<span class="nc" id="L179">            return userJson;</span>
        }
        
        try {
            // userJsonの最後の &quot;}&quot; を削除
<span class="nc" id="L184">            String baseJson = userJson.trim();</span>
<span class="nc bnc" id="L185" title="All 2 branches missed.">            if (baseJson.endsWith(&quot;}&quot;)) {</span>
<span class="nc" id="L186">                baseJson = baseJson.substring(0, baseJson.length() - 1).trim();</span>
            }
            
            // カンマがない場合は追加
<span class="nc bnc" id="L190" title="All 2 branches missed.">            if (!baseJson.endsWith(&quot;,&quot;)) {</span>
<span class="nc" id="L191">                baseJson = baseJson + &quot;,&quot;;</span>
            }
            
            // ポイント情報を &quot;points&quot; キーでラップして追加
<span class="nc" id="L195">            return baseJson + &quot;\&quot;points\&quot;:&quot; + pointsJson + &quot;}&quot;;</span>
<span class="nc" id="L196">        } catch (Exception e) {</span>
<span class="nc" id="L197">            System.err.println(&quot;Failed to merge JSON: &quot; + e.getMessage());</span>
<span class="nc" id="L198">            return userJson;</span>
        }
    }

    /**
     * ユーザー情報取得
     */
    @GET
    @Path(&quot;/users/{id}&quot;)
    public Response getUser(@PathParam(&quot;id&quot;) String idParam, @HeaderParam(&quot;Authorization&quot;) String authHeader) {
        try {
            // UUIDバリデーション
            UUID id;
            try {
<span class="nc" id="L212">                id = UUID.fromString(idParam);</span>
<span class="nc" id="L213">            } catch (IllegalArgumentException e) {</span>
<span class="nc" id="L214">                return Response.status(Response.Status.BAD_REQUEST)</span>
<span class="nc" id="L215">                        .entity(createErrorMap(&quot;Invalid UUID format&quot;))</span>
<span class="nc" id="L216">                        .build();</span>
<span class="nc" id="L217">            }</span>

            // 認証チェック
<span class="nc bnc" id="L220" title="All 2 branches missed.">            if (!isAuthenticated(authHeader)) {</span>
<span class="nc" id="L221">                return Response.status(Response.Status.UNAUTHORIZED)</span>
<span class="nc" id="L222">                        .entity(createErrorMap(&quot;Unauthorized&quot;))</span>
<span class="nc" id="L223">                        .build();</span>
            }

<span class="nc" id="L226">            Response userResponse = userServiceClient.getUser(id);</span>
<span class="nc" id="L227">            String body = userResponse.readEntity(String.class);</span>
<span class="nc" id="L228">            return Response.status(userResponse.getStatus())</span>
<span class="nc" id="L229">                    .entity(body)</span>
<span class="nc" id="L230">                    .build();</span>
<span class="nc" id="L231">        } catch (Exception e) {</span>
<span class="nc" id="L232">            return createErrorResponse(&quot;Failed to get user: &quot; + e.getMessage());</span>
        }
    }

    /**
     * 全ユーザー取得
     */
    @GET
    @Path(&quot;/users&quot;)
    public Response getAllUsers(@HeaderParam(&quot;Authorization&quot;) String authHeader) {
        try {
            // 認証チェック
<span class="nc bnc" id="L244" title="All 2 branches missed.">            if (!isAuthenticated(authHeader)) {</span>
<span class="nc" id="L245">                return Response.status(Response.Status.UNAUTHORIZED)</span>
<span class="nc" id="L246">                        .entity(createErrorMap(&quot;Unauthorized&quot;))</span>
<span class="nc" id="L247">                        .build();</span>
            }

<span class="nc" id="L250">            Response userResponse = userServiceClient.getAllUsers();</span>
<span class="nc" id="L251">            String body = userResponse.readEntity(String.class);</span>
<span class="nc" id="L252">            return Response.status(userResponse.getStatus())</span>
<span class="nc" id="L253">                    .entity(body)</span>
<span class="nc" id="L254">                    .build();</span>
<span class="nc" id="L255">        } catch (Exception e) {</span>
<span class="nc" id="L256">            return createErrorResponse(&quot;Failed to get users: &quot; + e.getMessage());</span>
        }
    }

    // ==================== ポイントエンドポイント ====================

    /**
     * ポイント残高取得
     * GET /api/points
     */
    @GET
    @Path(&quot;/points&quot;)
    public Response getPoints(@HeaderParam(&quot;Authorization&quot;) String authHeader) {
        try {
            // 認証チェック
<span class="nc bnc" id="L271" title="All 4 branches missed.">            if (authHeader == null || !authHeader.startsWith(&quot;Bearer &quot;)) {</span>
<span class="nc" id="L272">                return Response.status(Response.Status.UNAUTHORIZED)</span>
<span class="nc" id="L273">                        .entity(createErrorMap(&quot;Unauthorized&quot;))</span>
<span class="nc" id="L274">                        .build();</span>
            }

<span class="nc" id="L277">            String token = authHeader.substring(7);</span>
            
            // JWT検証
<span class="nc" id="L280">            Response verifyResponse = authServiceClient.verifyToken(token);</span>
<span class="nc bnc" id="L281" title="All 2 branches missed.">            if (verifyResponse.getStatus() != 200) {</span>
<span class="nc" id="L282">                return Response.status(Response.Status.UNAUTHORIZED)</span>
<span class="nc" id="L283">                        .entity(createErrorMap(&quot;Invalid token&quot;))</span>
<span class="nc" id="L284">                        .build();</span>
            }

            // Point Serviceにリクエストを転送
            try {
<span class="nc" id="L289">                Response pointResponse = pointServiceClient.getPoints(token);</span>
<span class="nc" id="L290">                String body = pointResponse.readEntity(String.class);</span>
                
                // Point Service停止時のエラーハンドリング
<span class="nc bnc" id="L293" title="All 2 branches missed.">                if (isServiceUnavailable(pointResponse.getStatus())) {</span>
<span class="nc" id="L294">                    return Response.status(Response.Status.SERVICE_UNAVAILABLE)</span>
<span class="nc" id="L295">                            .entity(createErrorMap(&quot;Service Unavailable&quot;))</span>
<span class="nc" id="L296">                            .build();</span>
                }
                
<span class="nc" id="L299">                return Response.status(pointResponse.getStatus())</span>
<span class="nc" id="L300">                        .entity(body)</span>
<span class="nc" id="L301">                        .build();</span>
<span class="nc" id="L302">            } catch (javax.ws.rs.ProcessingException e) {</span>
                // Point Service接続エラー（停止時など）
<span class="nc" id="L304">                return Response.status(Response.Status.SERVICE_UNAVAILABLE)</span>
<span class="nc" id="L305">                        .entity(createErrorMap(&quot;Service Unavailable&quot;))</span>
<span class="nc" id="L306">                        .build();</span>
            }
<span class="nc" id="L308">        } catch (Exception e) {</span>
<span class="nc" id="L309">            return createErrorResponse(&quot;Failed to get points: &quot; + e.getMessage());</span>
        }
    }

    /**
     * ポイント履歴取得
     * GET /api/points/history?page=1&amp;limit=10
     */
    @GET
    @Path(&quot;/points/history&quot;)
    public Response getPointHistory(
            @HeaderParam(&quot;Authorization&quot;) String authHeader,
            @QueryParam(&quot;page&quot;) @DefaultValue(&quot;1&quot;) int page,
            @QueryParam(&quot;limit&quot;) @DefaultValue(&quot;10&quot;) int limit) {
        try {
            // 認証チェック
<span class="nc bnc" id="L325" title="All 4 branches missed.">            if (authHeader == null || !authHeader.startsWith(&quot;Bearer &quot;)) {</span>
<span class="nc" id="L326">                return Response.status(Response.Status.UNAUTHORIZED)</span>
<span class="nc" id="L327">                        .entity(createErrorMap(&quot;Unauthorized&quot;))</span>
<span class="nc" id="L328">                        .build();</span>
            }

<span class="nc" id="L331">            String token = authHeader.substring(7);</span>
            
            // JWT検証
<span class="nc" id="L334">            Response verifyResponse = authServiceClient.verifyToken(token);</span>
<span class="nc bnc" id="L335" title="All 2 branches missed.">            if (verifyResponse.getStatus() != 200) {</span>
<span class="nc" id="L336">                return Response.status(Response.Status.UNAUTHORIZED)</span>
<span class="nc" id="L337">                        .entity(createErrorMap(&quot;Invalid token&quot;))</span>
<span class="nc" id="L338">                        .build();</span>
            }

            // Point Serviceにリクエストを転送
            try {
<span class="nc" id="L343">                Response pointResponse = pointServiceClient.getPointHistory(token, page, limit);</span>
<span class="nc" id="L344">                String body = pointResponse.readEntity(String.class);</span>
                
                // Point Service停止時のエラーハンドリング
<span class="nc bnc" id="L347" title="All 2 branches missed.">                if (isServiceUnavailable(pointResponse.getStatus())) {</span>
<span class="nc" id="L348">                    return Response.status(Response.Status.SERVICE_UNAVAILABLE)</span>
<span class="nc" id="L349">                            .entity(createErrorMap(&quot;Service Unavailable&quot;))</span>
<span class="nc" id="L350">                            .build();</span>
                }
                
<span class="nc" id="L353">                return Response.status(pointResponse.getStatus())</span>
<span class="nc" id="L354">                        .entity(body)</span>
<span class="nc" id="L355">                        .build();</span>
<span class="nc" id="L356">            } catch (javax.ws.rs.ProcessingException e) {</span>
                // Point Service接続エラー（停止時など）
<span class="nc" id="L358">                return Response.status(Response.Status.SERVICE_UNAVAILABLE)</span>
<span class="nc" id="L359">                        .entity(createErrorMap(&quot;Service Unavailable&quot;))</span>
<span class="nc" id="L360">                        .build();</span>
            }
<span class="nc" id="L362">        } catch (Exception e) {</span>
<span class="nc" id="L363">            return createErrorResponse(&quot;Failed to get point history: &quot; + e.getMessage());</span>
        }
    }

    // ==================== ヘルパーメソッド ====================

    private boolean isAuthenticated(String authHeader) {
<span class="nc bnc" id="L370" title="All 4 branches missed.">        if (authHeader == null || !authHeader.startsWith(&quot;Bearer &quot;)) {</span>
<span class="nc" id="L371">            return false;</span>
        }

        try {
<span class="nc" id="L375">            String token = authHeader.substring(7);</span>
<span class="nc" id="L376">            Response verifyResponse = authServiceClient.verifyToken(token);</span>
<span class="nc bnc" id="L377" title="All 2 branches missed.">            return verifyResponse.getStatus() == 200;</span>
<span class="nc" id="L378">        } catch (Exception e) {</span>
<span class="nc" id="L379">            return false;</span>
        }
    }

    private boolean isServiceUnavailable(int statusCode) {
<span class="nc bnc" id="L384" title="All 6 branches missed.">        return statusCode == 503 || statusCode == 502 || statusCode == 504;</span>
    }

    private UUID extractUserIdFromVerifyResponse(String jsonResponse) {
        // 簡易的な実装（実際は JSON ライブラリで適切にパースすべき）
        // 例: {&quot;valid&quot;:true,&quot;userId&quot;:&quot;550e8400-e29b-41d4-a716-446655440000&quot;,&quot;expiresAt&quot;:&quot;...&quot;}
        try {
<span class="nc" id="L391">            String userIdKey = &quot;\&quot;userId\&quot;:&quot;;</span>
<span class="nc" id="L392">            int userIdIndex = jsonResponse.indexOf(userIdKey);</span>
<span class="nc bnc" id="L393" title="All 2 branches missed.">            if (userIdIndex == -1) {</span>
<span class="nc" id="L394">                return null;</span>
            }
            // Skip past &quot;userId&quot;: to find the opening quote
<span class="nc" id="L397">            String substring = jsonResponse.substring(userIdIndex + userIdKey.length());</span>
<span class="nc" id="L398">            int openQuoteIndex = substring.indexOf(&quot;\&quot;&quot;);</span>
<span class="nc bnc" id="L399" title="All 2 branches missed.">            if (openQuoteIndex == -1) {</span>
<span class="nc" id="L400">                return null;</span>
            }
            // Find the closing quote after the opening quote
<span class="nc" id="L403">            String afterOpenQuote = substring.substring(openQuoteIndex + 1);</span>
<span class="nc" id="L404">            int closeQuoteIndex = afterOpenQuote.indexOf(&quot;\&quot;&quot;);</span>
<span class="nc bnc" id="L405" title="All 2 branches missed.">            if (closeQuoteIndex == -1) {</span>
<span class="nc" id="L406">                return null;</span>
            }
<span class="nc" id="L408">            String userIdStr = afterOpenQuote.substring(0, closeQuoteIndex);</span>
<span class="nc" id="L409">            return UUID.fromString(userIdStr);</span>
<span class="nc" id="L410">        } catch (Exception e) {</span>
<span class="nc" id="L411">            return null;</span>
        }
    }

    private Response createErrorResponse(String message) {
<span class="nc" id="L416">        return Response.status(Response.Status.INTERNAL_SERVER_ERROR)</span>
<span class="nc" id="L417">                .entity(createErrorMap(message))</span>
<span class="nc" id="L418">                .build();</span>
    }

    private Map&lt;String, String&gt; createErrorMap(String message) {
<span class="nc" id="L422">        Map&lt;String, String&gt; error = new HashMap&lt;&gt;();</span>
<span class="nc" id="L423">        error.put(&quot;error&quot;, message);</span>
<span class="nc" id="L424">        return error;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.10.202304240956</span></div></body></html>