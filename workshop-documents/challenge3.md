# 3.テストシナリオやクライテリアやテストデータを作成してテストを実行する

## このチャレンジで体験できること

* テストコードの生成をAgentモードを利用して生成できる
* Unit/Integration/e2eのそれぞれのテストの生成を実施できる

> [!NOTE]
> 途中から参加する場合は `challenge3` ブランチから実施できます。

## 目的

不足しているテストの実装を行いたいのですが、テストにおけるルールなどが存在しません。
テスト実装のヒント作成の為ドキュメントを充実させてテストを実行する必要がありそうです。  
* e2e Testにおいてはテストシナリオが必要そうです。  
    * e2e TestとIntegration Testはテスト時にTesContainersをデータソースとして使用しているようなのでシードデータを特定する必要がありそうです。  
* テスト全般では完了条件が不明確なのでそれを定義する必要がありそうです

## 手段

GitHub Copilotを使用して現在のアプリケーション構造などからシナリオやテストデータを作成していきます。 

ヒントになりそうなキーワード
* テストカバレッジ: Unitテストの完了条件として
* Cucumber（ふるまい駆動）: e2eテストはふるまい駆動型の構成になっているようです
* Playwright: e2eのテスト実行はPlaywrightのコード使用しているようです
* ページオブジェクトパターン: e2eテストの構造を壊れにくくするためPlaywrightはページオブジェクトパターンで構築されているようです
* FrontendはSPA(Vue)で構成されています。仮想ルーティングなど特殊な動きをしている為、その考慮をしてもらう必要がありそうです。

> [!TIP]
> `develop-standard` には共通規約として各テストに関わる規約が記載されています。
> テストカバレッジやパス率などプロジェクト専用に条件付けをしたい場合はプロンプトに加えると条件にしてくれます。プロジェクト専用のUnitTestドキュメントを作るなどしたい場合は共通規約をベースに新しいドキュメントを `docs` に作成したほうがいいかもしれません。

## Sample Prompt（Agent Mode）

### UnitTest

``` markdown
下記サービスのUnitTestを作成してください。CIは未実装なので、CIコマンドは記載しなくてOKです。
- user-service
- auth-service
- point-service
- bff

テストは下記の条件で実施してください
- テスト生成後はテストを実行し、テストがクリアするまで修正を行ってください。
- テストコードの作成を実施する際は実装コードの変更は行わないでください。
- テストレポートはGit管理の対象外としたい為 `/temp` ディレクトリに生成してください。
<!-- 以降は調整など好きに構成してください -->
- テストの規約に関しては `develop-standard` を参照してください。
```

### Integration Test

``` markdown
下記サービスでDBを使用したIntegration Testを作成してください。CIは未実装なので、CIコマンドは記載しなくてOKです。
- user-service
- auth-service
- point-service

テストは下記の条件で実施してください
- テストの際は開発用のDBを汚染させないため、TestContainersを使用します。
  - テストDBのテーブル作成などは既存の `database` ディレクトリ内のSQLを流用してください。
- テストで必要なTestContainersDBのSeedDataの構築も実施してください。
- テスト生成後はテストを実行し、テストがクリアするまで修正を行ってください。
- テストコードの作成を実施する際は実装コードの変更は行わないでください。
- テストレポートはGit管理の対象外としたい為 `/temp` ディレクトリに生成してください。
<!-- 以降は調整など好きに構成してください -->
- テストの規約に関しては `develop-standard` を参照してください。
```

> [!NOTE]
> いささか注文が細かいのですが参照してほしい情報も作ってしまう(SQLとか…)動きをしてしまうことが多い為こまかい指定を行っています。


### e2e Test

テストシナリオ作り。

``` markdown
現在のアプリケーションの構造からe2eテストを実施するためのシナリオを作成します。
シナリオは `src/e2e/features` にCucumberのフォーマットで `xxx.feature` として保存されます。
テストの際は開発用のDBを汚染させないため、TestContainersを使用します。
テストで必要なTestContainersDBのSeedDataの構築も実施してください。
テストコードの作成を実施する際は実装コードの変更は行わないでください。
テストシナリオができあがったらまずはシナリオのレビューを実施しますので作業を中断してください。
```

``` markdown
作成されたCucumberのシナリオに対して e2e テストを実装してください。
テストコードは壊れにくい構成にするため、PageObjectモデルで構成されたオブジェクトを介して実行されます。
実行は下記の条件のもと行われます。
- `src/e2e/features`内の情報からテストのシナリオを特定します。
- 各シナリオごとにテストを実装してください。
- すべてのシナリオが実装出来たら全部通してテストを実行し失敗が発生していないか確認してください。

<!-- 以降隙に調整してもらって結構です -->
下記に留意してください。  
- テストのガイドラインは `develop-standard` に記載されいるものを参照にしてください。
- テストレポートはGit管理の対象外としたい為 `/temp` ディレクトリに生成してください
- FrontはSPA(Vue)で構成されているためそれを考慮してテストを構成して下さい
- テストコードの作成を実施する際は実装コードの変更は行わないでください
```

> [!TIP]
> e2eテストの性質上時間がかかる傾向があるので一回作ってから個別に修正するほうが動き的にはマシです。
> このe2eをCopilotと修正していくともうちょっと細かいComponentに分離したくなってきます…。
> マシンリソースに自信がある人は git worktree を使って並行して修正してもらうといいかもしれません。

> [!TIP]
> Integrationやe2eテストは実行都度TestContainersが初期化されているためテスト実行都度のデータ整理は必要ありません

**注意:結構な数のテストができるはずです。実行時間結構かかりますので気になる方は個別で実行してください**

> [!CAUTION]
> E2Eのテストの修正を含めると結構な時間になるので時間内に完遂できない可能性が高いです。
> 時間がかかりそうであれば次のフェーズに進んでください。

### Custom Agentを利用したテストの作成

Frontendの単体テストが実装されていません。フロントエンド構成用のカスタムエージェントを作成しているのでそこで実行してみます。  
`frontend-test-orchestretor` がフロントエンドのテストを実装するオーケストレーターです。

> [!CAUTION]
> E2Eの実装が終了しなかった場合は `challenge3-2` ブランチで作業を行ってください。
> テストの実装と修正などを含むため実装に時間がかかる可能性があります。時間がかかりそうであれば次のフェーズに進んでください。
> Forkしている方はUnitTest作成のIssueを作成し、エージェント割り当てて放置しておくのも可能です

[次へ→](./challenge4.md)