# データベース構造（ER図）

本システムでは、マイクロサービスアーキテクチャの原則に従い、各サービスが独立したデータベースを持っています。

## データベース構成概要

```mermaid
graph TB
    subgraph "User Service DB (user_service_db)"
        U_USERS[users テーブル]
    end
    
    subgraph "Auth Service DB (auth_service_db)"
        A_CRED[user_credentials テーブル]
        A_SESSION[session_tokens テーブル]
        A_HISTORY[login_history テーブル]
    end
    
    subgraph "Point Service DB (point_service_db)"
        P_POINTS[points テーブル]
        P_HISTORY[point_history テーブル]
    end
    
    A_SESSION -->|FK: user_id| A_CRED
    A_HISTORY -->|FK: user_id| A_CRED
    P_HISTORY -->|FK: user_id| P_POINTS
    
    style U_USERS fill:#bfb,stroke:#333,stroke-width:2px
    style A_CRED fill:#bbf,stroke:#333,stroke-width:2px
    style A_SESSION fill:#bbf,stroke:#333,stroke-width:2px
    style A_HISTORY fill:#bbf,stroke:#333,stroke-width:2px
    style P_POINTS fill:#fbb,stroke:#333,stroke-width:2px
    style P_HISTORY fill:#fbb,stroke:#333,stroke-width:2px
```

**注意**: 各データベース間には**外部キー制約はありません**。サービス間でのデータ整合性は、共通の`userId`（UUID）を使用して論理的に保たれます。

---

## 1. User Service DB（user_service_db）

### usersテーブル

```mermaid
erDiagram
    users {
        UUID id PK "ユーザーID (Primary Key)"
        VARCHAR(50) username UK "ユーザー名 (Unique)"
        VARCHAR(100) email UK "メールアドレス (Unique)"
        VARCHAR(100) full_name "氏名"
        TIMESTAMP created_at "作成日時"
        TIMESTAMP updated_at "更新日時"
    }
```

**役割**: ユーザーの基本情報を管理

**制約**:
- `id`: PRIMARY KEY, UUID型、自動生成（`gen_random_uuid()`）
- `username`: UNIQUE, NOT NULL
- `email`: UNIQUE, NOT NULL
- `full_name`: NOT NULL

**インデックス**:
- `idx_users_username` on `username`
- `idx_users_email` on `email`

---

## 2. Auth Service DB（auth_service_db）

### user_credentialsテーブル

```mermaid
erDiagram
    user_credentials {
        SERIAL id PK "認証情報ID"
        UUID user_id UK "ユーザーID (Unique)"
        VARCHAR(255) password_hash "パスワードハッシュ (BCrypt)"
        TIMESTAMP created_at "作成日時"
        TIMESTAMP updated_at "更新日時"
    }
```

**役割**: ユーザーの認証情報（パスワードハッシュ）を管理

**制約**:
- `id`: PRIMARY KEY, SERIAL
- `user_id`: UNIQUE, NOT NULL
- `password_hash`: NOT NULL（BCryptでハッシュ化されたパスワード）

**インデックス**:
- `idx_user_credentials_user_id` on `user_id`

---

### session_tokensテーブル

```mermaid
erDiagram
    user_credentials {
        SERIAL id PK
        UUID user_id UK
        VARCHAR(255) password_hash
        TIMESTAMP created_at
        TIMESTAMP updated_at
    }
    
    session_tokens {
        SERIAL id PK "セッションID"
        UUID user_id FK "ユーザーID"
        VARCHAR(255) token UK "セッショントークン (Unique)"
        TIMESTAMP expires_at "有効期限"
        TIMESTAMP created_at "作成日時"
    }
    
    session_tokens }o--|| user_credentials : "user_id"
```

**役割**: ユーザーのセッショントークンを管理（レガシートークン用）

**制約**:
- `id`: PRIMARY KEY, SERIAL
- `token`: UNIQUE, NOT NULL
- `user_id`: FOREIGN KEY → `user_credentials(user_id)` ON DELETE CASCADE
- `expires_at`: NOT NULL

**インデックス**:
- `idx_session_tokens_token` on `token`
- `idx_session_tokens_user_id` on `user_id`

---

### login_historyテーブル

```mermaid
erDiagram
    user_credentials {
        SERIAL id PK
        UUID user_id UK
        VARCHAR(255) password_hash
        TIMESTAMP created_at
        TIMESTAMP updated_at
    }
    
    login_history {
        SERIAL id PK "ログイン履歴ID"
        UUID user_id FK "ユーザーID"
        TIMESTAMP login_time "ログイン日時"
        VARCHAR(45) ip_address "IPアドレス"
        TEXT user_agent "ユーザーエージェント"
        BOOLEAN success "成否 (TRUE=成功, FALSE=失敗)"
    }
    
    login_history }o--|| user_credentials : "user_id"
```

**役割**: ログイン履歴（成功・失敗含む）を記録

**制約**:
- `id`: PRIMARY KEY, SERIAL
- `user_id`: FOREIGN KEY → `user_credentials(user_id)` ON DELETE CASCADE
- `success`: NOT NULL, DEFAULT TRUE

**インデックス**:
- `idx_login_history_user_id` on `user_id`

---

## 3. Point Service DB（point_service_db）

### pointsテーブル

```mermaid
erDiagram
    points {
        UUID user_id PK "ユーザーID (Primary Key)"
        INTEGER balance "ポイント残高"
        TIMESTAMP last_updated "最終更新日時"
    }
```

**役割**: ユーザーのポイント残高を管理

**制約**:
- `user_id`: PRIMARY KEY, UUID
- `balance`: NOT NULL, DEFAULT 0

---

### point_historyテーブル

```mermaid
erDiagram
    points {
        UUID user_id PK
        INTEGER balance
        TIMESTAMP last_updated
    }
    
    point_history {
        SERIAL id PK "履歴ID"
        UUID user_id FK "ユーザーID"
        INTEGER amount "ポイント増減量"
        VARCHAR(20) transaction_type "取引種別 (EARN/USE)"
        TEXT description "説明"
        TIMESTAMP created_at "作成日時"
        TIMESTAMP expires_at "有効期限"
    }
    
    point_history }o--|| points : "user_id"
```

**役割**: ポイント取引履歴を記録

**制約**:
- `id`: PRIMARY KEY, SERIAL
- `user_id`: FOREIGN KEY → `points(user_id)` ON DELETE CASCADE
- `amount`: NOT NULL
- `transaction_type`: NOT NULL（'EARN' または 'USE'）

**インデックス**:
- `idx_point_history_user_id` on `user_id`
- `idx_point_history_created_at` on `created_at`

---

## サービス間のデータ連携

各サービスのデータベースは完全に独立しており、外部キーによる制約は存在しません。データの整合性は以下の方法で保たれています：

### 共通識別子: userId（UUID）

すべてのサービスで同一のUUID形式の`userId`を使用してユーザーを識別します。

**例**:
- User Service の `users.id`
- Auth Service の `user_credentials.user_id`
- Point Service の `points.user_id`

これらはすべて同じUUID値を持ち、論理的に同一ユーザーを指します。

### データ連携パターン

1. **ユーザー作成時**:
   - User Service で `users` テーブルにユーザーを作成（UUIDを生成）
   - 同じUUIDを使ってAuth Serviceで `user_credentials` を作成
   - 同じUUIDを使ってPoint Serviceで `points` を作成

2. **ユーザー削除時**:
   - 各サービスで独立して削除処理を実行
   - トランザクションの整合性は保証されない（最終的整合性）

### データベース接続情報

各サービスは環境変数から接続情報を読み込みます：

**User Service**:
```env
DB_USER_SERVICE_HOST=localhost
DB_USER_SERVICE_PORT=5432
DB_USER_SERVICE_NAME=user_service_db
DB_USER_SERVICE_USER=postgres
DB_USER_SERVICE_PASSWORD=postgres
```

**Auth Service**:
```env
DB_AUTH_SERVICE_HOST=localhost
DB_AUTH_SERVICE_PORT=5432
DB_AUTH_SERVICE_NAME=auth_service_db
DB_AUTH_SERVICE_USER=postgres
DB_AUTH_SERVICE_PASSWORD=postgres
```

**Point Service**:
```env
DB_POINT_SERVICE_HOST=localhost
DB_POINT_SERVICE_PORT=5432
DB_POINT_SERVICE_NAME=point_service_db
DB_POINT_SERVICE_USER=postgres
DB_POINT_SERVICE_PASSWORD=postgres
```

---

## データベース初期化

各サービスのデータベースは以下のSQLファイルで初期化されます：

- **スキーマ定義**: `database/schema.sql`
- **Seedデータ**: `database/seed.sql`

これらは開発環境（DevContainer）起動時、およびE2Eテスト実行時（TestContainers）に自動的に実行されます。
