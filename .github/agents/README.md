# Cucumber テスト自動化エージェント

このディレクトリには、GitHub Copilot のエージェントモードを使用して Cucumber テストの生成と修正を自動化するエージェント群が含まれています。

## エージェント構成

### オーケストレーター

- **cucumber-orchestrator** (`cucumber-orchestrator.agent.md`)
  - Cucumber テストの生成から実行、修正までの全体フローを管理
  - サブエージェントを呼び出して各フェーズを実行
  - テストが成功するまで自動的に修正を繰り返す

### サブエージェント

1. **scenario-builder** (`scenario-builder.agent.md`)
   - テスト対象機能の Cucumber シナリオ（feature ファイル）を生成
   - 既存のアプリケーションコードを分析
   - BDD のベストプラクティスに従ったシナリオを構築

2. **test-planner** (`test-planner.agent.md`)
   - 生成されたシナリオを分析してレビュー
   - 共通規約（develop-standard/）への準拠を確認
   - シナリオ間の依存関係を分析
   - 最適な実装順序を決定
   - 詳細な実装計画を作成

3. **test-runner** (`test-runner.agent.md`)
   - 指定されたシナリオのステップ定義とページオブジェクトを生成
   - テストを実行して結果を報告
   - シナリオごとに個別実行が可能

4. **test-fixer** (`test-fixer.agent.md`)
   - 失敗したテストのエラーログを分析
   - 根本原因を特定して修正を実施
   - ステップ定義、ページオブジェクト、シナリオを修正

## 実行フロー

```
1. シナリオ構築（scenario-builder）
   ↓
2. 実装計画（test-planner）
   - シナリオレビュー
   - 共通規約チェック
   - 実装順序の決定
   ↓
3. 各シナリオごとに（計画された順序で）:
   a. テスト実行（test-runner）
   b. 失敗した場合は修正（test-fixer）
   c. 成功するまで繰り返し
   ↓
4. 全テスト実行
   ↓
5. 失敗した場合は修正（test-fixer）
   ↓
6. すべてのテストが成功するまで繰り返し
```

## 使い方

### オーケストレーターの使用（推奨）

VS Code の GitHub Copilot Chat から以下のように実行します：

```
@cuシナリオのレビューと実装計画の策定
3. 計画された順序で各シナリオのテスト実行
4. 失敗した場合の修正
5. 全体のテスト実行
6ーケストレーターが自動的に以下を実行します：
1. シナリオの構築
2. 各シナリオのテスト実行
3. 失敗した場合の修正
4. 全体のテスト実行
5. すべてのテストが成功するまで修正を繰り返し

### 個別エージェントの使用

各エージェントは単独でも使用できます：

#### シナリオ構築のみ
```
@scenario-builder アカウント情報表示機能のテストシナリオを作成してください
```
実装計画のみ
```
@test-planner features/point-management.feature のシナリオをレビューして実装計画を作成してください
```

#### 
#### テスト実行のみ
```
@test-runner features/point-management.feature ファイルの "ポイントを付与できる" シナリオを実行してください
```

#### テスト修正のみ
```
@test-fixer 以下のエラーを修正してください:
[エラーログをコピー]
```

## 前提条件

- VS Code に GitHub Copilot がインストールされていること
- Node.js と npm がインストールされていること
- プロジェクトの依存関係がインストールされていること（`npm install`）

## プロジェクト構造

```
src/e2e/
├── features/           # Cucumber feature ファイル
│   └── *.feature
├── step-definitions/   # ステップ定義
│   └── *.steps.ts
├── pages/              # ページオブジェクト
│   └── *Page.ts
├── setup/              # テスト環境セットアップ
└── cucumber.js         # Cucumber 設定
```

## 注意事項

### オートメーション実行時

- エージェントはユーザーにインタラクションを求めません
- `/dev/null` の使用は避けてください（オートメーションが停止します）
- TestContainers のフックス設定（`hooks.ts`）は変更されません

### テスト実行

- 各シナリオは独立して実行されます
- TestContainers により自動的にテスト用 DB が起動します
- テスト終了後は自動的にクリーンアップされます

### 修正の制限

- 最大修正回数:
  - 個別シナリオ: 3回
  - 全体テスト: 5回
- 制限に達しても失敗する場合は、詳細なエラー情報とともに報告されます

## ベストプラクティス

1. **明確な要求**: オーケストレーターに対して、テストしたい機能を明確に伝えてください
2. **段階的な実行**: 大きな機能は複数の小さな機能に分割してテストを作成してください
3. **既存パターンの活用**: 既存のテストを参考に、一貫性のあるテストを作成してください
4. **エラーログの保存**: 修正が必要な場合は、詳細なエラーログを保存してください

## トラブルシューティング

### エージェントが認識されない

VS Code を再起動してください。

### テストが繰り返し失敗する

1. エラーログを確認して根本原因を特定してください
2. フロントエンドのコードが変更されていないか確認してください
3. TestContainers が正常に起動しているか確認してください

### 修正が期待通りに動作しない

1. 既存のテストが正常に動作するか確認してください
2. 生成されたコードを手動でレビューしてください
3. 必要に応じて手動で修正してください

## 参考

- [GitHub Copilot エージェント作成ガイド](https://docs.github.com/en/copilot/how-tos/use-copilot-agents/coding-agent/create-custom-agents)
- [Cucumber ドキュメント](https://cucumber.io/docs/guides/)
- [Playwright ドキュメント](https://playwright.dev/docs/intro)
- [オーケストレーターパターンの実践](https://zenn.dev/openjny/articles/e11450f61d067f)
